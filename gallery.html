<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial-Werkstatt - Galerie</title>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --primary-bg: #e8f5e9;
            --text: #333;
            --text-light: #666;
            --text-muted: #999;
            --bg: #f5f5f5;
            --bg-white: #fff;
            --border: #ddd;
            --border-light: #eee;
            --danger: #d32f2f;
            --warning: #f57c00;
            --success: #388e3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .gallery-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 40px 32px;
            text-align: center;
        }

        .gallery-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .gallery-header .subtitle {
            font-size: 16px;
            opacity: 0.85;
            margin-bottom: 20px;
        }

        .header-nav {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .header-link {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .header-link:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Toolbar */
        .gallery-toolbar {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-wrapper input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
        }

        .toolbar-info {
            font-size: 14px;
            color: var(--text-light);
            white-space: nowrap;
        }

        /* Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
            padding: 32px;
            flex: 1;
        }

        /* Cards */
        .tutorial-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tutorial-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .card-accent {
            height: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .card-body {
            padding: 20px 24px;
            flex: 1;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .meta-steps {
            background: var(--primary-bg);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .meta-url {
            color: var(--text-muted);
            text-decoration: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meta-url:hover {
            color: var(--primary);
        }

        .card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .step-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        .type-click { background: #7b1fa2; }
        .type-input { background: #0288d1; }
        .type-navigate { background: #00796b; }
        .type-drag { background: #e64a19; }
        .type-local_action { background: #5d4037; }
        .type-wait { background: #616161; }

        /* Card Footer */
        .card-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            text-align: center;
        }

        .bookmarklet-link {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bookmarklet-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46,125,50,0.3);
        }

        .bookmarklet-link:active {
            cursor: grabbing;
        }

        .card-footer .hint {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 80px 32px;
            color: var(--text-light);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 32px;
            color: var(--text-light);
        }

        .empty-state .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .empty-state a {
            color: var(--primary);
        }

        /* Footer */
        .gallery-footer {
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            padding: 24px 32px;
            text-align: center;
            font-size: 14px;
            color: var(--text-muted);
        }

        .gallery-footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .gallery-footer a:hover {
            text-decoration: underline;
        }

        /* Error Toast */
        .error-banner {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #e65100;
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gallery-header { padding: 28px 16px; }
            .gallery-header h1 { font-size: 22px; }
            .gallery-toolbar { padding: 12px 16px; }
            .gallery-grid {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <header class="gallery-header">
        <h1>Tutorial-Werkstatt</h1>
        <p class="subtitle">Interaktive Anleitungen zum Mitnehmen</p>
        <nav class="header-nav">
            <a href="index.html" class="header-link">Zum Editor</a>
        </nav>
    </header>

    <div class="gallery-toolbar">
        <div class="search-wrapper">
            <span class="search-icon">&#128269;</span>
            <input type="text" id="searchInput" placeholder="Tutorials durchsuchen..." />
        </div>
        <div class="toolbar-info">
            <span id="tutorialCount"></span>
        </div>
    </div>

    <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <p>Tutorials werden geladen...</p>
    </div>

    <div id="galleryGrid" class="gallery-grid" style="display:none;"></div>

    <div id="emptyState" class="empty-state" style="display:none;">
        <div class="empty-icon">&#128218;</div>
        <h3>Keine Tutorials gefunden</h3>
        <p>Erstelle ein Tutorial im <a href="index.html">Editor</a>.</p>
    </div>

    <footer class="gallery-footer">
        <p>Tutorial-Werkstatt &mdash; Start with a Friend</p>
        <p><a href="index.html">Editor &ouml;ffnen</a></p>
    </footer>

    <script>
    (function() {
        'use strict';

        var tutorials = [];
        var grid = document.getElementById('galleryGrid');
        var searchInput = document.getElementById('searchInput');
        var tutorialCount = document.getElementById('tutorialCount');
        var emptyState = document.getElementById('emptyState');
        var loadingState = document.getElementById('loadingState');

        // ==========================================
        // Hilfsfunktionen
        // ==========================================

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getDomain(url) {
            try { return new URL(url).hostname; }
            catch(e) { return url; }
        }

        function countStepTypes(steps) {
            var counts = {};
            (steps || []).forEach(function(s) {
                var type = s.type || 'unknown';
                counts[type] = (counts[type] || 0) + 1;
            });
            return counts;
        }

        // ==========================================
        // Bookmarklet Generator
        // KOPIE aus app.js generatePlayerCode() - synchron halten!
        // Letzte Aktualisierung: 2026-02-07 (Spotlight, Panel, Tooltip, Overlay-Erkennung, Scoring-Match)
        // ==========================================

        function generatePlayerCode(tutorial) {
            // Tutorial-Daten kompakt
            var tutorialData = {
                n: tutorial.name,
                d: tutorial.description,
                u: tutorial.startUrl,
                s: (tutorial.steps || []).map(function(s, idx) {
                    return {
                        t: s.type,
                        d: s.description,
                        tr: s.trigger || s.description,
                        u: s.url,
                        up: s.urlPattern || '',
                        o: s.optional,
                        e: s.isEntryPoint,
                        v: s.exampleValue,
                        i: s.instruction,
                        idx: idx
                    };
                })
            };

            // Tutorial-ID f√ºr Storage
            var tutorialId = 'swf_player_' + (tutorial.id || (tutorial.name || 'tutorial').replace(/\s+/g, '_'));

            var playerScript = '(function(){"use strict";var d=' + JSON.stringify(tutorialData) + ';var STORAGE_KEY="' + tutorialId + '";var currentStep=0;var completedSteps=[];try{var saved=sessionStorage.getItem(STORAGE_KEY);if(saved){var state=JSON.parse(saved);currentStep=state.step||0;completedSteps=state.completed||[];}}catch(e){}function saveState(){try{sessionStorage.setItem(STORAGE_KEY,JSON.stringify({step:currentStep,completed:completedSteps,url:location.href}));}catch(e){}}function clearState(){try{sessionStorage.removeItem(STORAGE_KEY);}catch(e){}}function $(q){try{return document.querySelector(q)}catch(e){return null}}function $$(q){try{return document.querySelectorAll(q)}catch(e){return[]}}function $c(t,a){var e=document.createElement(t);if(a)Object.keys(a).forEach(function(k){e[k]=a[k]});return e}function getAccName(el){if(!el||el.nodeType!==1)return"";var aria=el.getAttribute("aria-label");if(aria)return aria.trim();var labelledBy=el.getAttribute("aria-labelledby");if(labelledBy){var parts=labelledBy.split(/\\s+/).map(function(id){var lbl=document.getElementById(id);return lbl?lbl.textContent.trim():""}).filter(Boolean);if(parts.length)return parts.join(" ")}var tag=el.tagName;if(tag==="INPUT"||tag==="SELECT"||tag==="TEXTAREA"){if(el.id){var lbl=document.querySelector("label[for=\\""+CSS.escape(el.id)+"\\"]");if(lbl)return lbl.textContent.trim()}var parentLabel=el.closest("label");if(parentLabel){var clone=parentLabel.cloneNode(true);clone.querySelectorAll("input,select,textarea").forEach(function(i){i.remove()});var t=clone.textContent.trim();if(t)return t}if(el.placeholder)return el.placeholder.trim();if(el.name)return el.name}if(tag==="BUTTON"||(tag==="INPUT"&&["submit","button","reset"].includes(el.type))){return el.value||el.textContent.trim()||el.getAttribute("title")||""}if(tag==="A"){var img=el.querySelector("img[alt]");if(img)return img.alt;return el.textContent.trim()||el.getAttribute("title")||""}return el.textContent.trim().substring(0,80)}function getElementType(el){var tag=el.tagName.toLowerCase();var type=el.getAttribute("type")||"";var role=el.getAttribute("role")||"";if(tag==="input")return"input-"+(type||"text");if(tag==="button"||role==="button")return"button";if(tag==="a"||role==="link")return"link";if(tag==="select")return"select";if(tag==="textarea")return"textarea";return tag}function scanPage(){var elements=[];var selectors="button,a[href],input:not([type=hidden]),select,textarea,[role=button],[role=link],[role=menuitem],[role=option],[role=tab],[tabindex]:not([tabindex=\\"-1\\"]),summary,[onclick],.btn,.button";$$(selectors).forEach(function(el,index){if(!isVisible(el))return;var name=getAccName(el);elements.push({el:el,name:name,nameLower:name.toLowerCase(),type:getElementType(el),index:index})});return elements}function isVisible(el){if(!el)return false;var st=window.getComputedStyle(el);if(st.display==="none"||st.visibility==="hidden"||st.opacity==="0")return false;var r=el.getBoundingClientRect();if(r.width<=0||r.height<=0)return false;if(el.closest("[aria-hidden=\\"true\\"]"))return false;if(r.bottom<0||r.top>window.innerHeight||r.right<0||r.left>window.innerWidth)return false;var points=[{x:r.left+r.width/2,y:r.top+r.height/2},{x:r.left+5,y:r.top+5},{x:r.right-5,y:r.top+5},{x:r.left+5,y:r.bottom-5},{x:r.right-5,y:r.bottom-5}];for(var i=0;i<points.length;i++){var p=points[i];if(p.x<0||p.x>window.innerWidth||p.y<0||p.y>window.innerHeight)continue;var topEl=document.elementFromPoint(p.x,p.y);if(topEl){if(topEl===el||el.contains(topEl)||topEl.contains(el)){return true}}}return false}function extractWords(text){return text.toLowerCase().replace(/[^a-z√§√∂√º√ü0-9\\s]/gi," ").split(/\\s+/).filter(function(w){return w.length>2})}function findElement(step){var trigger=(step.tr||step.d||"").trim();if(!trigger)return null;var alternatives=trigger.split("|").map(function(t){return t.trim()}).filter(Boolean);var elements=scanPage();for(var altIdx=0;altIdx<alternatives.length;altIdx++){var altTrigger=alternatives[altIdx];var result=findElementByTrigger(altTrigger,elements);if(result){result.matchedTrigger=altTrigger;return result}}return null}function calculateMatchScore(searchLower,searchWords,item){var score=0;var itemWords=extractWords(item.name);if(item.nameLower===searchLower){return 1000}if(item.nameLower.indexOf(searchLower)!==-1){score+=100;var lengthRatio=searchLower.length/item.nameLower.length;score+=Math.round(lengthRatio*50)}if(searchWords.length>0){var matchedSearchWords=0;var matchedItemWords=0;searchWords.forEach(function(sw){if(item.nameLower.indexOf(sw)!==-1){matchedSearchWords++;score+=sw.length}});itemWords.forEach(function(iw){if(searchLower.indexOf(iw)!==-1){matchedItemWords++}});var searchWordRatio=matchedSearchWords/searchWords.length;score+=Math.round(searchWordRatio*80);if(matchedSearchWords===searchWords.length){score+=50}if(itemWords.length>0){var itemWordRatio=matchedItemWords/itemWords.length;score+=Math.round(itemWordRatio*30)}}return score}function findElementByTrigger(trigger,elements){var searchLower=trigger.toLowerCase();var searchWords=extractWords(trigger);var match=elements.find(function(item){return item.nameLower===searchLower});if(match)return{el:match.el,strategy:"exact"};var bestMatch=null;var bestScore=0;var bestStrategy="scored";elements.forEach(function(item){var score=calculateMatchScore(searchLower,searchWords,item);if(score>bestScore){bestScore=score;bestMatch=item}});if(bestMatch&&bestScore>=50){if(bestScore>=150)bestStrategy="partial";else if(bestScore>=100)bestStrategy="words-all";else bestStrategy="words-partial";return{el:bestMatch.el,strategy:bestStrategy,score:bestScore}}var genericPatterns=[{pattern:/bearbeiten|edit|√§ndern/i,types:["button","link"]},{pattern:/speichern|save/i,types:["button","input-submit"]},{pattern:/l√∂schen|delete|entfernen/i,types:["button","link"]},{pattern:/suche|search/i,types:["input-text","input-search"]},{pattern:/weiter|next|fortfahren/i,types:["button","input-submit"]},{pattern:/zur√ºck|back|abbrechen|cancel/i,types:["button","link"]}];for(var i=0;i<genericPatterns.length;i++){var gp=genericPatterns[i];if(gp.pattern.test(trigger)){match=elements.find(function(item){return gp.types.includes(item.type)});if(match)return{el:match.el,strategy:"structural"}}}if(/button|schaltfl√§che|knopf/i.test(trigger)){match=elements.find(function(item){return item.type==="button"});if(match)return{el:match.el,strategy:"type-button"}}if(/link|verweis/i.test(trigger)){match=elements.find(function(item){return item.type==="link"});if(match)return{el:match.el,strategy:"type-link"}}if(/eingabe|feld|input/i.test(trigger)){match=elements.find(function(item){return item.type.startsWith("input-")});if(match)return{el:match.el,strategy:"type-input"}}return null}function waitForElement(step,callback,maxWait){maxWait=maxWait||8000;var startTime=Date.now();function check(){var result=findElement(step);if(result){callback(result.el,result.strategy);return}if(Date.now()-startTime<maxWait){window.setTimeout(check,300)}else{callback(null,null)}}check()}function injectStyles(){if($("#swf-styles"))return;var st=$c("style",{id:"swf-styles"});st.textContent=".swf-panel{position:fixed;top:20px;right:20px;width:280px;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);z-index:2147483646;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;overflow:hidden;transition:all 0.3s ease}.swf-panel.minimized{width:180px}.swf-panel.minimized .swf-panel-body{display:none}.swf-panel-header{background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;cursor:move;user-select:none}.swf-panel-title{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.swf-panel-buttons{display:flex;gap:4px}.swf-panel-btn{background:rgba(255,255,255,0.2);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}.swf-panel-btn:hover{background:rgba(255,255,255,0.3)}.swf-panel-body{max-height:350px;overflow-y:auto}.swf-panel-progress{padding:10px 14px;background:#f8f8f8;border-bottom:1px solid #eee}.swf-progress-bar{height:4px;background:#e0e0e0;border-radius:2px;overflow:hidden}.swf-progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#2e7d32);transition:width 0.3s}.swf-progress-text{font-size:11px;color:#888;margin-top:4px;text-align:center}.swf-tooltip{position:fixed;background:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.15);max-width:300px;z-index:2147483647;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;animation:swf-fade-in 0.2s ease}@keyframes swf-fade-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.swf-tooltip-arrow{position:absolute;width:10px;height:10px;background:#fff;transform:rotate(45deg);box-shadow:-2px -2px 4px rgba(0,0,0,0.05)}.swf-tooltip-arrow.top{bottom:-5px;left:20px}.swf-tooltip-arrow.bottom{top:-5px;left:20px;box-shadow:2px 2px 4px rgba(0,0,0,0.05)}.swf-tooltip-content{padding:14px}.swf-tooltip-step{font-size:11px;color:#2e7d32;font-weight:600;margin-bottom:4px}.swf-tooltip-text{font-size:14px;line-height:1.4;color:#333;margin-bottom:12px}.swf-tooltip-buttons{display:flex;gap:6px;flex-wrap:wrap}.swf-step-list{list-style:none;margin:0;padding:0}.swf-step-item{padding:8px 14px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:12px;transition:background 0.2s}.swf-step-item:hover{background:#fafafa}.swf-step-item.completed{background:#e8f5e9}.swf-step-item.current{background:#fff3e0;border-left:3px solid #f57c00}.swf-step-item.skipped{opacity:0.5}.swf-step-num{width:20px;height:20px;border-radius:50%;background:#e0e0e0;color:#666;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;flex-shrink:0}.swf-step-item.completed .swf-step-num{background:#4caf50;color:#fff}.swf-step-item.current .swf-step-num{background:#f57c00;color:#fff}.swf-step-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.swf-btn{padding:8px 12px;border:none;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer}.swf-btn-primary{background:#2e7d32;color:#fff}.swf-btn-primary:hover{background:#1b5e20}.swf-btn-secondary{background:#f0f0f0;color:#333}.swf-btn-secondary:hover{background:#e0e0e0}.swf-highlight{position:fixed;border:3px solid #2e7d32;border-radius:6px;pointer-events:none;z-index:2147483645;box-shadow:0 0 0 3px rgba(46,125,50,0.2);animation:swf-ring-pulse 1.5s ease-in-out infinite}@keyframes swf-ring-pulse{0%,100%{box-shadow:0 0 0 3px rgba(46,125,50,0.2)}50%{box-shadow:0 0 0 6px rgba(46,125,50,0.15),0 0 15px rgba(46,125,50,0.2)}}.swf-welcome-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2147483647;display:flex;align-items:center;justify-content:center}.swf-welcome-box{background:#fff;border-radius:20px;padding:40px;text-align:center;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.swf-welcome-box h2{color:#2e7d32;margin:16px 0 8px}.swf-welcome-box p{color:#666;margin-bottom:24px}";document.head.appendChild(st)}var panel=null;var highlight=null;var spotlight=null;var tooltip=null;var panelMinimized=false;var panelDragOffset={x:0,y:0};function createSpotlight(el){removeSpotlight();if(!el)return;var rect=el.getBoundingClientRect();var padding=8;spotlight=$c("div",{id:"swf-spotlight"});spotlight.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;z-index:2147483640;pointer-events:none;";var svgNS="http://www.w3.org/2000/svg";var svg=document.createElementNS(svgNS,"svg");svg.setAttribute("width","100%");svg.setAttribute("height","100%");svg.style.cssText="position:absolute;top:0;left:0;";var defs=document.createElementNS(svgNS,"defs");var mask=document.createElementNS(svgNS,"mask");mask.setAttribute("id","swf-spotlight-mask");var bgRect=document.createElementNS(svgNS,"rect");bgRect.setAttribute("width","100%");bgRect.setAttribute("height","100%");bgRect.setAttribute("fill","white");var hole=document.createElementNS(svgNS,"rect");hole.setAttribute("x",rect.left-padding);hole.setAttribute("y",rect.top-padding);hole.setAttribute("width",rect.width+padding*2);hole.setAttribute("height",rect.height+padding*2);hole.setAttribute("rx","8");hole.setAttribute("fill","black");mask.appendChild(bgRect);mask.appendChild(hole);defs.appendChild(mask);svg.appendChild(defs);var overlay=document.createElementNS(svgNS,"rect");overlay.setAttribute("width","100%");overlay.setAttribute("height","100%");overlay.setAttribute("fill","rgba(0,0,0,0.6)");overlay.setAttribute("mask","url(#swf-spotlight-mask)");svg.appendChild(overlay);spotlight.appendChild(svg);document.body.appendChild(spotlight);spotlight._updatePosition=function(){var newRect=el.getBoundingClientRect();hole.setAttribute("x",newRect.left-padding);hole.setAttribute("y",newRect.top-padding);hole.setAttribute("width",newRect.width+padding*2);hole.setAttribute("height",newRect.height+padding*2)};window.addEventListener("scroll",spotlight._updatePosition,true);window.addEventListener("resize",spotlight._updatePosition)}function removeSpotlight(){if(spotlight){window.removeEventListener("scroll",spotlight._updatePosition,true);window.removeEventListener("resize",spotlight._updatePosition);spotlight.remove();spotlight=null}}function createTooltip(el,step,idx){removeTooltip();if(!el)return;var rect=el.getBoundingClientRect();tooltip=$c("div",{className:"swf-tooltip",id:"swf-tooltip"});var showAbove=rect.top>200;var top=showAbove?rect.top-10:rect.bottom+10;var left=Math.max(10,Math.min(rect.left,window.innerWidth-340));tooltip.innerHTML="<div class=\\"swf-tooltip-arrow "+(showAbove?"top":"bottom")+"\\"></div><div class=\\"swf-tooltip-content\\"><div class=\\"swf-tooltip-step\\">Schritt "+(idx+1)+" von "+d.s.length+"</div><div class=\\"swf-tooltip-text\\">"+step.d+"</div><div class=\\"swf-tooltip-buttons\\">"+(idx>0?"<button class=\\"swf-btn swf-btn-secondary\\" id=\\"swf-tip-prev\\">‚Üê Zur√ºck</button>":"")+"<button class=\\"swf-btn swf-btn-secondary\\" id=\\"swf-tip-skip\\">√úberspringen</button><button class=\\"swf-btn swf-btn-primary\\" id=\\"swf-tip-done\\">‚úì Erledigt</button></div></div>";tooltip.style.cssText="position:fixed;top:"+(showAbove?"auto":top+"px")+";bottom:"+(showAbove?(window.innerHeight-rect.top+10)+"px":"auto")+";left:"+left+"px;";document.body.appendChild(tooltip);if($("#swf-tip-prev")){$("#swf-tip-prev").addEventListener("click",function(){goToStep(idx-1)})}$("#swf-tip-skip").addEventListener("click",function(){goToStep(idx+1)});$("#swf-tip-done").addEventListener("click",function(){if(!completedSteps.includes(idx))completedSteps.push(idx);goToStep(idx+1)})}function removeTooltip(){if(tooltip){tooltip.remove();tooltip=null}}function makePanelDraggable(panelEl){var header=panelEl.querySelector(".swf-panel-header");if(!header)return;var isDragging=false;header.addEventListener("mousedown",function(e){if(e.target.tagName==="BUTTON")return;isDragging=true;panelDragOffset.x=e.clientX-panelEl.offsetLeft;panelDragOffset.y=e.clientY-panelEl.offsetTop;header.style.cursor="grabbing"});document.addEventListener("mousemove",function(e){if(!isDragging)return;var x=e.clientX-panelDragOffset.x;var y=e.clientY-panelDragOffset.y;x=Math.max(0,Math.min(x,window.innerWidth-panelEl.offsetWidth));y=Math.max(0,Math.min(y,window.innerHeight-panelEl.offsetHeight));panelEl.style.left=x+"px";panelEl.style.right="auto";panelEl.style.top=y+"px"});document.addEventListener("mouseup",function(){isDragging=false;header.style.cursor="move"})}function createPanel(){if(panel)return;panel=$c("div",{className:"swf-panel",id:"swf-panel"});var progressPercent=Math.round((completedSteps.length/d.s.length)*100);panel.innerHTML="<div class=\\"swf-panel-header\\"><span class=\\"swf-panel-title\\">üå± "+d.n+"</span><div class=\\"swf-panel-buttons\\"><button class=\\"swf-panel-btn\\" id=\\"swf-minimize\\" title=\\"Minimieren\\">‚àí</button><button class=\\"swf-panel-btn\\" id=\\"swf-close-panel\\" title=\\"Beenden\\">√ó</button></div></div><div class=\\"swf-panel-body\\"><div class=\\"swf-panel-progress\\"><div class=\\"swf-progress-bar\\"><div class=\\"swf-progress-fill\\" style=\\"width:"+progressPercent+"%\\"></div></div><div class=\\"swf-progress-text\\">"+completedSteps.length+" von "+d.s.length+" erledigt</div></div><ul class=\\"swf-step-list\\" id=\\"swf-step-list\\"></ul></div>";document.body.appendChild(panel);makePanelDraggable(panel);$("#swf-minimize").addEventListener("click",function(){panelMinimized=!panelMinimized;panel.classList.toggle("minimized",panelMinimized);this.textContent=panelMinimized?"+":"‚àí"});$("#swf-close-panel").addEventListener("click",function(){if(confirm("Tutorial beenden?")){cleanup()}});updateStepList()}function updateStepList(){var list=$("#swf-step-list");if(!list)return;var progressPercent=Math.round((completedSteps.length/d.s.length)*100);var progressFill=$(".swf-progress-fill");var progressText=$(".swf-progress-text");if(progressFill)progressFill.style.width=progressPercent+"%";if(progressText)progressText.textContent=completedSteps.length+" von "+d.s.length+" erledigt";list.innerHTML=d.s.map(function(step,idx){var status="";if(completedSteps.includes(idx))status="completed";else if(idx===currentStep)status="current";else if(idx<currentStep&&!completedSteps.includes(idx))status="skipped";var number=completedSteps.includes(idx)?"‚úì":(idx+1);var shortDesc=step.d.length>40?step.d.substring(0,40)+"...":step.d;return"<li class=\\"swf-step-item "+status+"\\" data-step=\\""+idx+"\\"><span class=\\"swf-step-num\\">"+number+"</span><span class=\\"swf-step-text\\" title=\\""+step.d.replace(/"/g,"&quot;")+"\\">"+shortDesc+"</span></li>"}).join("");list.querySelectorAll(".swf-step-item").forEach(function(item){item.addEventListener("click",function(){var idx=parseInt(this.getAttribute("data-step"));goToStep(idx)})});var currentItem=list.querySelector(".swf-step-item.current");if(currentItem){currentItem.scrollIntoView({behavior:"smooth",block:"center"})}}function showHighlight(el,stepIdx,step){removeHighlight();el.scrollIntoView({behavior:"smooth",block:"center"});createSpotlight(el);highlight=$c("div",{className:"swf-highlight",id:"swf-highlight"});document.body.appendChild(highlight);function updatePosition(){if(!highlight||!document.body.contains(highlight))return;var r=el.getBoundingClientRect();highlight.style.cssText="position:fixed;top:"+(r.top-5)+"px;left:"+(r.left-5)+"px;width:"+(r.width+10)+"px;height:"+(r.height+10)+"px";if(spotlight&&spotlight._updatePosition){spotlight._updatePosition()}}window.setTimeout(function(){updatePosition();if(step){createTooltip(el,step,stepIdx)}},400);var scrollCount=0;var scrollInterval=window.setInterval(function(){updatePosition();scrollCount++;if(scrollCount>20){window.clearInterval(scrollInterval)}},50);var onScroll=function(){updatePosition()};window.addEventListener("scroll",onScroll,true);window.addEventListener("resize",onScroll);var onClick=function(e){if(stepIdx!==undefined&&!completedSteps.includes(stepIdx)){completedSteps.push(stepIdx)}window.setTimeout(function(){goToStep(currentStep+1)},100)};el.addEventListener("click",onClick,true);highlight._cleanup=function(){window.clearInterval(scrollInterval);window.removeEventListener("scroll",onScroll,true);window.removeEventListener("resize",onScroll);el.removeEventListener("click",onClick,true);removeSpotlight();removeTooltip()}}function removeHighlight(){if(highlight){if(highlight._cleanup)highlight._cleanup();highlight.remove();highlight=null}var existing=$("#swf-highlight");if(existing){if(existing._cleanup)existing._cleanup();existing.remove()}}function showWelcome(){injectStyles();var overlay=$c("div",{className:"swf-welcome-overlay",id:"swf-welcome"});var resumeText=currentStep>0?"<p style=\\"color:#f57c00\\">üìç Fortschritt geladen: Schritt "+(currentStep+1)+" von "+d.s.length+"</p>":"";var btnText=currentStep>0?"Fortfahren":"Los geht\\'s!";overlay.innerHTML="<div class=\\"swf-welcome-box\\"><div style=\\"font-size:64px\\">üå±</div><h2>Start with a Friend</h2><p><strong>"+d.n+"</strong></p><p>"+(d.d||"Lass uns gemeinsam durch diese Anleitung gehen!")+"</p>"+resumeText+"<button class=\\"swf-btn swf-btn-primary\\" id=\\"swf-start\\" style=\\"padding:14px 32px;font-size:16px;border-radius:30px\\">"+btnText+"</button></div>";document.body.appendChild(overlay);$("#swf-start").addEventListener("click",function(){overlay.remove();createPanel();goToStep(currentStep)})}function showComplete(){removeHighlight();clearState();updateStepList();var overlay=$c("div",{className:"swf-welcome-overlay",id:"swf-welcome"});overlay.innerHTML="<div class=\\"swf-welcome-box\\"><div style=\\"font-size:64px\\">üéâ</div><h2 style=\\"color:#2e7d32\\">Geschafft!</h2><p>Du hast das Tutorial abgeschlossen.</p><button class=\\"swf-btn swf-btn-primary\\" id=\\"swf-finish\\" style=\\"padding:14px 32px;font-size:16px;border-radius:30px\\">Schlie√üen</button></div>";document.body.appendChild(overlay);$("#swf-finish").addEventListener("click",cleanup)}function goToStep(idx){removeHighlight();if(idx>=d.s.length){showComplete();return}if(idx<0)idx=0;currentStep=idx;saveState();updateStepList();var step=d.s[idx];if(step.t==="local_action"||step.t==="navigate"||step.t==="wait"){var overlay=$c("div",{className:"swf-welcome-overlay",id:"swf-welcome"});var icon=step.t==="navigate"?"üîó":(step.t==="wait"?"‚è≥":"üìÅ");overlay.innerHTML="<div class=\\"swf-welcome-box\\"><div style=\\"font-size:48px\\">"+icon+"</div><h2 style=\\"color:#5d4037\\">"+step.d+"</h2>"+(step.i?"<div style=\\"background:#f5f5f5;padding:16px;border-radius:8px;text-align:left;margin:20px 0\\">"+step.i+"</div>":"")+"<div style=\\"margin-top:24px\\">"+(idx>0?"<button class=\\"swf-btn swf-btn-secondary\\" id=\\"swf-prev\\" style=\\"margin-right:12px\\">‚Üê Zur√ºck</button>":"")+"<button class=\\"swf-btn swf-btn-primary\\" id=\\"swf-done\\">‚úì Erledigt</button></div><p style=\\"margin-top:16px;font-size:13px;color:#999\\">Schritt "+(idx+1)+" von "+d.s.length+"</p></div>";document.body.appendChild(overlay);$("#swf-done").addEventListener("click",function(){overlay.remove();if(!completedSteps.includes(idx))completedSteps.push(idx);goToStep(idx+1)});if($("#swf-prev")){$("#swf-prev").addEventListener("click",function(){overlay.remove();goToStep(idx-1)})}return}waitForElement(step,function(el,strategy){if(el){showHighlight(el,idx,step)}else{if(step.o){goToStep(idx+1);return}var overlay=$c("div",{className:"swf-welcome-overlay",id:"swf-welcome"});overlay.innerHTML="<div class=\\"swf-welcome-box\\"><div style=\\"font-size:48px\\">‚ö†Ô∏è</div><h2 style=\\"color:#f57c00\\">Element nicht gefunden</h2><p>"+step.d+"</p><p style=\\"font-size:13px;color:#999\\">Gesucht: \\""+(step.tr||"")+"\\\"</p><div style=\\"margin-top:24px\\"><button class=\\"swf-btn swf-btn-secondary\\" id=\\"swf-skip\\" style=\\"margin-right:12px\\">√úberspringen</button><button class=\\"swf-btn swf-btn-primary\\" id=\\"swf-retry\\">Erneut suchen</button></div></div>";document.body.appendChild(overlay);$("#swf-skip").addEventListener("click",function(){overlay.remove();goToStep(idx+1)});$("#swf-retry").addEventListener("click",function(){overlay.remove();goToStep(idx)})}})}window.addEventListener("beforeunload",function(e){if(panel&&currentStep<d.s.length){saveState()}});document.addEventListener("click",function(e){if(!panel)return;var link=e.target.closest("a[href]");if(!link)return;var href=link.getAttribute("href");if(!href||href.startsWith("#")||href.startsWith("javascript:"))return;try{var url=new URL(href,location.href);if(url.origin===location.origin&&url.pathname===location.pathname)return}catch(ex){return}saveState();var toast=$c("div");toast.style.cssText="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1976d2;color:#fff;padding:12px 24px;border-radius:8px;z-index:2147483647;font-family:sans-serif;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,0.3)";toast.textContent="üí° Klicke auf der n√§chsten Seite erneut auf das Bookmarklet!";document.body.appendChild(toast);window.setTimeout(function(){toast.remove()},2000)},true);function cleanup(){removeHighlight();if(panel){panel.remove();panel=null}document.body.classList.remove("swf-active");var welcome=$("#swf-welcome");if(welcome)welcome.remove();var styles=$("#swf-styles");if(styles)styles.remove();clearState()}if(document.getElementById("swf-panel")){return}injectStyles();showWelcome()})();';

            return 'javascript:' + encodeURIComponent(playerScript);
        }

        // ==========================================
        // Karten rendern
        // ==========================================

        var typeLabels = {
            click: 'Klick',
            input: 'Eingabe',
            navigate: 'Navigation',
            drag: 'Drag & Drop',
            local_action: 'Lokal',
            wait: 'Warten'
        };

        function renderCard(tutorial) {
            var card = document.createElement('div');
            card.className = 'tutorial-card';
            card.dataset.name = (tutorial.name || '').toLowerCase();
            card.dataset.description = (tutorial.description || '').toLowerCase();

            var steps = tutorial.steps || [];
            var typeCounts = countStepTypes(steps);

            var badgesHtml = '';
            Object.keys(typeCounts).forEach(function(type) {
                badgesHtml += '<span class="step-badge type-' + type + '">' +
                    typeCounts[type] + 'x ' + escapeHtml(typeLabels[type] || type) + '</span>';
            });

            var metaUrlHtml = '';
            if (tutorial.startUrl) {
                metaUrlHtml = '<a class="meta-url" href="' + escapeHtml(tutorial.startUrl) +
                    '" target="_blank" rel="noopener">' + escapeHtml(getDomain(tutorial.startUrl)) + '</a>';
            }

            card.innerHTML =
                '<div class="card-accent"></div>' +
                '<div class="card-body">' +
                '<h3 class="card-title">' + escapeHtml(tutorial.name || 'Unbenannt') + '</h3>' +
                '<p class="card-description">' + escapeHtml(tutorial.description || '') + '</p>' +
                '<div class="card-meta">' +
                '<span class="meta-steps">' + steps.length + ' Schritte</span>' +
                metaUrlHtml +
                '</div>' +
                '<div class="card-badges">' + badgesHtml + '</div>' +
                '</div>' +
                '<div class="card-footer">' +
                '<a class="bookmarklet-link" title="Ziehe mich in deine Lesezeichenleiste!">' +
                escapeHtml(tutorial.name || 'Tutorial') + '</a>' +
                '<span class="hint">In Lesezeichenleiste ziehen</span>' +
                '</div>';

            // Bookmarklet-href per DOM setzen (sicher gegen Encoding-Probleme)
            var link = card.querySelector('.bookmarklet-link');
            link.href = generatePlayerCode(tutorial);

            // Klick verhindern (soll nur gezogen werden)
            link.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Ziehe diesen Link in deine Lesezeichenleiste, um das Tutorial zu nutzen!');
            });

            return card;
        }

        // ==========================================
        // Galerie rendern & filtern
        // ==========================================

        function renderGallery() {
            var query = searchInput.value.trim().toLowerCase();
            grid.innerHTML = '';
            var matchCount = 0;

            tutorials.forEach(function(tutorial) {
                var name = (tutorial.name || '').toLowerCase();
                var desc = (tutorial.description || '').toLowerCase();
                if (query && name.indexOf(query) === -1 && desc.indexOf(query) === -1) {
                    return;
                }
                grid.appendChild(renderCard(tutorial));
                matchCount++;
            });

            tutorialCount.textContent = matchCount + ' Tutorial' + (matchCount !== 1 ? 's' : '');
            emptyState.style.display = matchCount === 0 ? 'block' : 'none';
            grid.style.display = matchCount > 0 ? 'grid' : 'none';
        }

        // ==========================================
        // Daten laden
        // ==========================================

        function loadTutorials() {
            fetch('tutorials.json')
                .then(function(r) {
                    if (!r.ok) throw new Error('tutorials.json nicht gefunden');
                    return r.json();
                })
                .then(function(index) {
                    var promises = index.map(function(entry) {
                        return fetch(entry.file)
                            .then(function(r) {
                                if (!r.ok) throw new Error(entry.file + ' nicht gefunden');
                                return r.json();
                            })
                            .catch(function(err) {
                                console.error('Fehler beim Laden:', entry.file, err);
                                return null;
                            });
                    });
                    return Promise.all(promises);
                })
                .then(function(results) {
                    tutorials = results.filter(function(t) { return t !== null; });
                    loadingState.style.display = 'none';
                    renderGallery();
                })
                .catch(function(err) {
                    console.error('Fehler beim Laden der Tutorial-Liste:', err);
                    loadingState.innerHTML =
                        '<div class="empty-icon">&#9888;</div>' +
                        '<p>Tutorials konnten nicht geladen werden.</p>' +
                        '<p style="font-size:13px;color:#999;margin-top:8px;">Die Seite muss &uuml;ber einen Webserver (oder GitHub Pages) ge&ouml;ffnet werden.</p>';
                });
        }

        // ==========================================
        // Events
        // ==========================================

        searchInput.addEventListener('input', function() {
            renderGallery();
        });

        // ==========================================
        // Start
        // ==========================================

        loadTutorials();
    })();
    </script>
</body>
</html>
